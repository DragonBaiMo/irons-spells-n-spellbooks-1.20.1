Iron's Spells 'n Spellbooks (1.20.1 Forge) - ä»£ç æ¶æ„å…¨é¢åˆ†ææŠ¥å‘Š

ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

é¡¹ç›®åç§°: Iron's Spells 'n Spellbooksç‰ˆæœ¬: Minecraft 1.20.1 Forge Modä¸»åŒ…è·¯å¾„:
io.redspace.ironsspellbooksä¸»ç±»: .\src\main\java\io\r
edspace\ironsspellbooks\IronsSpellbooks.java

---
1. æ–½æ³•ç³»ç»Ÿæ¶æ„ (Spell Casting System)

1.1 æ ¸å¿ƒæŠ½è±¡ç±»ï¼šAbstractSpell

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\spells\AbstractSpell.java

è¿™æ˜¯æ•´ä¸ªæ–½æ³•ç³»ç»Ÿçš„åŸºçŸ³ï¼Œæ‰€æœ‰æŠ€èƒ½éƒ½ç»§æ‰¿è‡ªè¿™ä¸ªæŠ½è±¡ç±»ã€‚

æ ¸å¿ƒå±æ€§ï¼š

private String spellID;                    // æŠ€èƒ½å”¯ä¸€æ ‡è¯†ç¬¦
private String spellName;                  // æŠ€èƒ½åç§°
protected int baseManaCost;                // åŸºç¡€é­”æ³•æ¶ˆè€—
protected int manaCostPerLevel;            // æ¯çº§é­”æ³•æ¶ˆè€—å¢é‡
protected int baseSpellPower;              // åŸºç¡€æŠ€èƒ½å¨åŠ›
protected int spellPowerPerLevel;          // æ¯çº§å¨åŠ›å¢é‡
protected int castTime;                    // æ–½æ³•æ—¶é—´ï¼ˆtickï¼‰

æ ¸å¿ƒæ–¹æ³•æµç¨‹ï¼š

1. æ–½æ³•å¯åŠ¨æµç¨‹ (attemptInitiateCast):
public boolean attemptInitiateCast(ItemStack stack, int spellLevel, Level level,
                                    Player player, CastSource castSource,
                                    boolean triggerCooldown, String castingEquipmentSlot)
æµç¨‹ï¼š
- éªŒè¯æ˜¯å¦åœ¨æœåŠ¡ç«¯
- è·å–ç©å®¶é­”æ³•æ•°æ® (MagicData)
- æ£€æŸ¥æ–½æ³•æ¡ä»¶ (canBeCastedBy + checkPreCastConditions)
- è§¦å‘äº‹ä»¶ (SpellPreCastEvent)
- åˆå§‹åŒ–æ–½æ³•çŠ¶æ€ (playerMagicData.initiateCast)
- åŒæ­¥å®¢æˆ·ç«¯ (ClientboundUpdateCastingState)
- è°ƒç”¨é¢„æ–½æ³•é’©å­ (onServerPreCast)

2. æ–½æ³•æ‰§è¡Œæµç¨‹ (castSpell):
public void castSpell(Level world, int spellLevel, ServerPlayer serverPlayer,
                    CastSource castSource, boolean triggerCooldown)
æµç¨‹ï¼š
- è§¦å‘æ–½æ³•äº‹ä»¶ (SpellOnCastEvent)
- æ‰£é™¤é­”æ³•å€¼
- è°ƒç”¨æŠ€èƒ½æ•ˆæœ (onCast)
- å¤„ç† Recast ç³»ç»Ÿ
- è®¾ç½®å†·å´æ—¶é—´
- åŒæ­¥å®¢æˆ·ç«¯ (ClientboundOnClientCast)

3. æ–½æ³•æ¡ä»¶æ£€æŸ¥ (canBeCastedBy):
public CastResult canBeCastedBy(int spellLevel, CastSource castSource,
                                MagicData playerMagicData, Player player)
æ£€æŸ¥é¡¹ï¼š
- å†’é™©æ¨¡å¼é™åˆ¶
- é­”æ³•å€¼æ˜¯å¦è¶³å¤Ÿ
- å†·å´æ—¶é—´æ£€æŸ¥
- Recast çŠ¶æ€æ£€æŸ¥
- å·è½´ç‰¹æ®Šé™åˆ¶

4. å‰ç½®æ¡ä»¶æ£€æŸ¥ (checkPreCastConditions):
public boolean checkPreCastConditions(Level level, int spellLevel,
                                    LivingEntity entity, MagicData playerMagicData)
- é»˜è®¤è¿”å› true
- å­ç±»å¯é‡å†™ä»¥å®ç°ç‰¹æ®Šé€»è¾‘ï¼ˆå¦‚éœ€è¦ç›®æ ‡ã€ç‰¹æ®Šç¯å¢ƒç­‰ï¼‰

5. æ ¸å¿ƒæ–½æ³•æ•ˆæœ (onCast):
public void onCast(Level level, int spellLevel, LivingEntity entity,
                    CastSource castSource, MagicData playerMagicData)
- æœåŠ¡ç«¯æ‰§è¡Œä¸»è¦é€»è¾‘
- ç”Ÿæˆç²’å­æ•ˆæœã€ä¼¤å®³ã€å¬å”¤å®ä½“ç­‰

6. å®¢æˆ·ç«¯æ•ˆæœ (onClientCast):
public void onClientCast(Level level, int spellLevel, LivingEntity entity, ICastData castData)
- å®¢æˆ·ç«¯ä¸“ç”¨ï¼Œå¤„ç†éŸ³æ•ˆå’Œç²’å­

---
1.2 æ–½æ³•ç±»å‹ (CastType)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\spells\CastType.java

public enum CastType {
    NONE(0),           // æ— æ–½æ³•ç±»å‹
    INSTANT(1),        // ç¬å‘æŠ€èƒ½ï¼ˆæ— æ–½æ³•æ—¶é—´ï¼‰
    LONG(2),           // åŸå”±æŠ€èƒ½ï¼ˆéœ€è¦å®Œæˆæ–½æ³•æ—¶é—´ï¼‰
    CONTINUOUS(3);     // æŒç»­æ–½æ³•ï¼ˆæŒ‰ä½æ–½æ³•é”®æŒç»­ç”Ÿæ•ˆï¼‰
}

å…³é”®ç‰¹æ€§:
- LONG å’Œ CONTINUOUS ä¼šç«‹å³æŠ‘åˆ¶å³é”®ç‚¹å‡»
- CONTINUOUS ç±»å‹ä¼šæ¯éš” CONTINUOUS_CAST_TICK_INTERVAL (10 ticks) æ‰§è¡Œä¸€æ¬¡ castSpell

---
1.3 æ–½æ³•æ¥æº (CastSource)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\spells\CastSource.java

public enum CastSource {
    SPELLBOOK,  // æ³•æœ¯ä¹¦æ–½æ³•ï¼ˆæ¶ˆè€—é­”æ³•ï¼Œéµå®ˆå†·å´ï¼‰
    SCROLL,     // å·è½´æ–½æ³•ï¼ˆä¸æ¶ˆè€—é­”æ³•ï¼Œæ— å†·å´ï¼‰
    SWORD,      // é™„é­”æ­¦å™¨æ–½æ³•ï¼ˆå¯é…ç½®é­”æ³•æ¶ˆè€—ï¼‰
    MOB,        // ç”Ÿç‰©æ–½æ³•
    COMMAND,    // æŒ‡ä»¤æ–½æ³•
    NONE;       // æ— æ¥æº
}

å…³é”®æ–¹æ³•:
public boolean consumesMana() {
    return this == SPELLBOOK || (this == SWORD && ServerConfigs.SWORDS_CONSUME_MANA.get());
}

public boolean respectsCooldown() {
    return this == SPELLBOOK || this == SWORD;
}

---
1.4 æ–½æ³•ç»“æœ (CastResult)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\spells\CastResult.java

public class CastResult {
    public enum Type {
        SUCCESS,
        FAILURE
    }

    public final Type type;
    public final @Nullable Component message;  // å¤±è´¥æ—¶çš„æç¤ºæ¶ˆæ¯
}

---
2. æŠ€èƒ½æ³¨å†Œä¸ç®¡ç†ç³»ç»Ÿ

2.1 SpellRegistry (æŠ€èƒ½æ³¨å†Œè¡¨)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\registry\SpellRegistry.java

æ ¸å¿ƒæœºåˆ¶ï¼š

public class SpellRegistry {
    public static final ResourceKey<Registry<AbstractSpell>> SPELL_REGISTRY_KEY =
        ResourceKey.createRegistryKey(ResourceLocation.fromNamespaceAndPath(IronsSpellbooks.MODID,
"spells"));

    private static final DeferredRegister<AbstractSpell> SPELLS =
        DeferredRegister.create(SPELL_REGISTRY_KEY, IronsSpellbooks.MODID);

    public static final Supplier<IForgeRegistry<AbstractSpell>> REGISTRY =
        SPELLS.makeRegistry(() -> new RegistryBuilder<AbstractSpell>()
            .disableSaving()
            .disableOverrides());

    private static final NoneSpell noneSpell = new NoneSpell();  // ç©ºæŠ€èƒ½å ä½ç¬¦
}

å…³é”® APIï¼š

// æ ¹æ® ID è·å–æŠ€èƒ½
public static AbstractSpell getSpell(String spellId)
public static AbstractSpell getSpell(ResourceLocation resourceLocation)

// è·å–å¯ç”¨çš„æŠ€èƒ½åˆ—è¡¨
public static List<AbstractSpell> getEnabledSpells()

// è·å–ç‰¹å®šå­¦æ´¾çš„æŠ€èƒ½
public static List<AbstractSpell> getSpellsForSchool(SchoolType schoolType)

æŠ€èƒ½æ³¨å†Œç¤ºä¾‹ï¼š

// BLOOD ç³»æŠ€èƒ½
public static final RegistryObject<AbstractSpell> BLOOD_SLASH_SPELL =
    registerSpell(new BloodSlashSpell());
public static final RegistryObject<AbstractSpell> HEARTSTOP_SPELL =
    registerSpell(new HeartstopSpell());

// FIRE ç³»æŠ€èƒ½
public static final RegistryObject<AbstractSpell> FIREBOLT_SPELL =
    registerSpell(new FireboltSpell());
public static final RegistryObject<AbstractSpell> FIREBALL_SPELL =
    registerSpell(new FireballSpell());

// HOLY ç³»æŠ€èƒ½
public static final RegistryObject<AbstractSpell> HEAL_SPELL =
    registerSpell(new HealSpell());
public static final RegistryObject<AbstractSpell> GREATER_HEAL_SPELL =
    registerSpell(new GreaterHealSpell());

// æ€»è®¡ 90+ æŠ€èƒ½ï¼Œåˆ†å¸ƒåœ¨ 8 ä¸ªå­¦æ´¾

---
2.2 æŠ€èƒ½æ•°æ®ç»“æ„ (SpellData)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\spells\SpellData.java

public class SpellData implements Comparable<SpellData> {
    public static final SpellData EMPTY = new SpellData(SpellRegistry.none(), 0, false);

    protected final AbstractSpell spell;    // æŠ€èƒ½å®ä¾‹
    protected final int spellLevel;         // æŠ€èƒ½ç­‰çº§
    protected final boolean locked;         // æ˜¯å¦é”å®šï¼ˆä¸å¯ç§»é™¤ï¼‰

    public AbstractSpell getSpell()
    public int getLevel()
    public SpellRarity getRarity()          // æ ¹æ®ç­‰çº§è®¡ç®—ç¨€æœ‰åº¦
}

---
3. ç©å®¶æ–½æ³•ç³»ç»Ÿä¸æ•°æ®ç®¡ç†

3.1 MagicData (ç©å®¶é­”æ³•æ•°æ®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\magic\MagicData.java

è¿™æ˜¯ç©å®¶é­”æ³•çŠ¶æ€çš„æ ¸å¿ƒæ•°æ®å®¹å™¨ï¼Œé€šè¿‡ Capability ç³»ç»Ÿé™„åŠ åˆ°ç©å®¶å®ä½“ã€‚

æ ¸å¿ƒå­—æ®µï¼š

é­”æ³•å€¼ç³»ç»Ÿ:
private float mana;                         // å½“å‰é­”æ³•å€¼

public float getMana()
public void setMana(float mana)             // è§¦å‘ ChangeManaEvent
public void addMana(float mana)

æ–½æ³•çŠ¶æ€:
private int castingSpellLevel = 0;          // æ–½æ³•æŠ€èƒ½ç­‰çº§
private int castDuration = 0;               // æ€»æ–½æ³•æ—¶é•¿
private int castDurationRemaining = 0;      // å‰©ä½™æ–½æ³•æ—¶é•¿
private CastSource castSource;              // æ–½æ³•æ¥æº
private CastType castType;                  // æ–½æ³•ç±»å‹
private ICastData additionalCastData;       // é¢å¤–æ–½æ³•æ•°æ®ï¼ˆå¦‚ç›®æ ‡ã€ä½ç½®ç­‰ï¼‰
private ItemStack castingItemStack;         // æ–½æ³•ç‰©å“

public void initiateCast(AbstractSpell spell, int spellLevel, int castDuration,
                        CastSource castSource, String castingEquipmentSlot)
public void resetCastingState()
public boolean isCasting()

å†·å´ä¸é‡æ–½ç³»ç»Ÿ:
private final PlayerCooldowns playerCooldowns = new PlayerCooldowns();
private PlayerRecasts playerRecasts = new PlayerRecasts();

public PlayerCooldowns getPlayerCooldowns()
public PlayerRecasts getPlayerRecasts()

åŒæ­¥æ•°æ®:
private SyncedSpellData syncedSpellData;    // å®¢æˆ·ç«¯åŒæ­¥çš„æ•°æ®

è·å–å®ä¾‹æ–¹æ³•ï¼š

public static MagicData getPlayerMagicData(LivingEntity livingEntity) {
    if (livingEntity instanceof IMagicEntity magicEntity) {
        return magicEntity.getMagicData();
    } else if (livingEntity instanceof ServerPlayer serverPlayer) {
        var capContainer = serverPlayer.getCapability(PlayerMagicProvider.PLAYER_MAGIC);
        // ...è¿”å› Capability ä¸­çš„ MagicData
    } else {
        return new MagicData(true);  // æ™®é€šç”Ÿç‰©çš„ä¸´æ—¶æ•°æ®
    }
}

---
3.2 MagicManager (é­”æ³•ç®¡ç†å™¨)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\cap
abilities\magic\MagicManager.java

æ ¸å¿ƒèŒè´£ï¼š

1. é­”æ³•å€¼æ¢å¤:
public static final int MANA_REGEN_TICKS = 10;  // æ¯10 tickæ¢å¤ä¸€æ¬¡

public boolean regenPlayerMana(ServerPlayer serverPlayer, MagicData playerMagicData) {
    int playerMaxMana = (int) serverPlayer.getAttributeValue(MAX_MANA.get());
    var mana = playerMagicData.getMana();
    if (mana != playerMaxMana) {
        float playerManaRegenMultiplier =
            (float) serverPlayer.getAttributeValue(MANA_REGEN.get());
        var increment = playerMaxMana * 0.01f * playerManaRegenMultiplier;
        playerMagicData.setMana(Mth.clamp(
            playerMagicData.getMana() + increment, 0, playerMaxMana
        ));
        return true;
    }
    return false;
}

2. æ–½æ³•çŠ¶æ€ç®¡ç† (Tick å¾ªç¯):
public void tick(Level level) {
    boolean doManaRegen = level.getServer().getTickCount() % MANA_REGEN_TICKS == 0;

    level.players().forEach(player -> {
        MagicData playerMagicData = MagicData.getPlayerMagicData(serverPlayer);
        playerMagicData.getPlayerCooldowns().tick(1);
        playerMagicData.getPlayerRecasts().tick(2);

        if (playerMagicData.isCasting()) {
            playerMagicData.handleCastDuration();
            var spell = SpellRegistry.getSpell(playerMagicData.getCastingSpellId());

            // INSTANT / LONG ç±»å‹ï¼šæ—¶é—´ç»“æŸåæ–½æ³•
            if (spell.getCastType() == CastType.LONG && !serverPlayer.isUsingItem()) {
                if (playerMagicData.getCastDurationRemaining() <= 0) {
                    spell.castSpell(...);
                    spell.onServerCastComplete(...);
                }
            }
            // CONTINUOUS ç±»å‹ï¼šæ¯éš”ä¸€å®šé—´éš”æŒç»­æ–½æ³•
            else if (spell.getCastType() == CastType.CONTINUOUS) {
                if ((playerMagicData.getCastDurationRemaining() + 1) % CONTINUOUS_CAST_TICK_INTERVAL == 0) {
                    spell.castSpell(...);
                }
            }

            spell.onServerCastTick(...);  // æ¯ tick è°ƒç”¨
        }

        if (doManaRegen) {
            regenPlayerMana(serverPlayer, playerMagicData);
        }
    });
}

3. å†·å´ç®¡ç†:
public void addCooldown(ServerPlayer serverPlayer, AbstractSpell spell, CastSource castSource) {
    if (castSource == CastSource.SCROLL) return;  // å·è½´æ— å†·å´

    int effectiveCooldown = getEffectiveSpellCooldown(spell, serverPlayer, castSource);
    MagicData.getPlayerMagicData(serverPlayer)
        .getPlayerCooldowns()
        .addCooldown(spell, effectiveCooldown);
    Messages.sendToPlayer(new ClientboundSyncCooldown(spell.getSpellId(), effectiveCooldown), serverPlayer);
}

public static int getEffectiveSpellCooldown(AbstractSpell spell, Player player, CastSource castSource) {
    double playerCooldownModifier = player.getAttributeValue(COOLDOWN_REDUCTION.get());
    float itemCoolDownModifer = (castSource == CastSource.SWORD)
        ? ServerConfigs.SWORDS_CD_MULTIPLIER.get().floatValue()
        : 1;

    return (int) (spell.getSpellCooldown()
        * (2 - Utils.softCapFormula(playerCooldownModifier))
        * itemCoolDownModifer);
}

---
4. æ–½æ³•å‚æ•°ä¸æ•°æ®ä¼ é€’ç³»ç»Ÿ

4.1 ICastData æ¥å£ä½“ç³»

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\api\spells\ICastData.java

public interface ICastData {
    void reset();  // é‡ç½®æ•°æ®
}

public interface ICastDataSerializable extends ICastData, ISerializable, INBTSerializable<CompoundTag> {
    // æ”¯æŒç½‘ç»œåºåˆ—åŒ–å’Œ NBT å­˜å‚¨
}

---
4.2 å†…ç½® CastData å®ç°

1. EntityCastData (å®ä½“å¼•ç”¨æ•°æ®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\spe
lls\EntityCastData.java

public class EntityCastData implements ICastData {
    private final Entity castingEntity;  // æ–½æ³•äº§ç”Ÿçš„å®ä½“å¼•ç”¨

    public Entity getCastingEntity()
    public void discardCastingEntity()   // ç§»é™¤å®ä½“
    public void reset()                  // æ¸…ç†æ—¶è‡ªåŠ¨ç§»é™¤å®ä½“
}

ä½¿ç”¨åœºæ™¯: å¬å”¤ç±»æŠ€èƒ½ã€æŒç»­å­˜åœ¨çš„æŠ€èƒ½å®ä½“

---
2. TargetEntityCastData (ç›®æ ‡å®ä½“æ•°æ®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\cap
abilities\magic\TargetEntityCastData.java

public class TargetEntityCastData implements ICastData {
    private final UUID targetUUID;  // ç›®æ ‡å®ä½“ UUID

    public TargetEntityCastData(LivingEntity target) {
        this.targetUUID = target.getUUID();
    }

    @Nullable
    public LivingEntity getTarget(ServerLevel level) {
        return (LivingEntity) level.getEntity(targetUUID);
    }

    @Nullable
    public Vec3 getTargetPosition(ServerLevel level)
}

ä½¿ç”¨åœºæ™¯: å•ç›®æ ‡æŠ€èƒ½ï¼ˆå¦‚è¿½è¸ªå¯¼å¼¹ã€æ²»ç–—ã€æ§åˆ¶æŠ€èƒ½ï¼‰

å…¸å‹ä½¿ç”¨æµç¨‹:
// 1. checkPreCastConditions ä¸­è®¾ç½®ç›®æ ‡
@Override
public boolean checkPreCastConditions(Level level, int spellLevel,
                                    LivingEntity entity, MagicData playerMagicData) {
    return Utils.preCastTargetHelper(level, entity, playerMagicData, this, 32, .35f);
    // preCastTargetHelper ä¼šè‡ªåŠ¨è®¾ç½® TargetEntityCastData
}

// 2. onCast ä¸­è·å–ç›®æ ‡
@Override
public void onCast(Level level, int spellLevel, LivingEntity entity,
                    CastSource castSource, MagicData playerMagicData) {
    if (playerMagicData.getAdditionalCastData() instanceof TargetEntityCastData castTargetingData) {
        var target = castTargetingData.getTarget((ServerLevel) level);
        if (target != null) {
            // å¯¹ç›®æ ‡æ‰§è¡Œæ•ˆæœ
        }
    }
}

---
3. TargetAreaCastData (åŒºåŸŸç›®æ ‡æ•°æ®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\spe
lls\TargetAreaCastData.java

public class TargetAreaCastData extends EntityCastData {
    Vec3 center;  // åŒºåŸŸä¸­å¿ƒç‚¹

    public TargetAreaCastData(Vec3 center, TargetedAreaEntity entity) {
        super(entity);
        this.center = center;
    }

    public Vec3 getCenter()
    public TargetedAreaEntity getCastingEntity()
}

ä½¿ç”¨åœºæ™¯: åŒºåŸŸæ•ˆæœæŠ€èƒ½ï¼ˆå¦‚åœ°éœ‡ã€ç«å¢™ã€æ²»ç–—åœˆï¼‰

---
4. ImpulseCastData (å†²åˆº/ä½ç§»æ•°æ®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\cap
abilities\magic\ImpulseCastData.java

public class ImpulseCastData implements ICastDataSerializable {
    private Vec3 impulse;  // ä½ç§»å‘é‡

    public void setImpulse(Vec3 impulse)
    public Vec3 getImpulse()
}

ä½¿ç”¨åœºæ™¯: ä½ç§»æŠ€èƒ½ï¼ˆå¦‚é—ªç°ã€å†²åˆºã€é£è¡Œï¼‰

---
5. MultiTargetEntityCastData (å¤šç›®æ ‡æ•°æ®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\cap
abilities\magic\MultiTargetEntityCastData.java

ç”¨äºå¤šç›®æ ‡æŠ€èƒ½æˆ–è¿é”æŠ€èƒ½ã€‚

---
4.3 è‡ªå®šä¹‰ CastData ç¤ºä¾‹

æŠ€èƒ½å¯ä»¥é€šè¿‡é‡å†™ getEmptyCastData() æä¾›è‡ªå®šä¹‰æ•°æ®ï¼š

// ç¤ºä¾‹ï¼šPortal æŠ€èƒ½çš„è‡ªå®šä¹‰æ•°æ®
@Override
public ICastDataSerializable getEmptyCastData() {
    return new PortalData();  // åŒ…å«ä¼ é€é—¨ä½ç½®ã€ç›®æ ‡ç»´åº¦ç­‰æ•°æ®
}

// ç¤ºä¾‹ï¼šFire Wall æŠ€èƒ½çš„è‡ªå®šä¹‰æ•°æ®
@Override
public ICastDataSerializable getEmptyCastData() {
    return new FireWallData(0);  // åŒ…å«ç«å¢™æ—‹è½¬è§’åº¦ç­‰å‚æ•°
}

---
5. ç½‘ç»œé€šä¿¡ç³»ç»Ÿ

5.1 å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯

ServerboundCast (å‘èµ·æ–½æ³•)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\net
work\ServerboundCast.java

public class ServerboundCast {
    public boolean handle(Supplier<NetworkEvent.Context> supplier) {
        ctx.enqueueWork(() -> {
            ServerPlayer serverPlayer = ctx.getSender();
            Utils.serverSideInitiateCast(serverPlayer);  // è°ƒç”¨æ–½æ³•é€»è¾‘
        });
        return true;
    }
}

è§¦å‘æµç¨‹:
// Utils.serverSideInitiateCast() è¯¦ç»†æµç¨‹ï¼š
public static boolean serverSideInitiateCast(ServerPlayer serverPlayer) {
    var ssm = new SpellSelectionManager(serverPlayer);
    var spellItem = ssm.getSelection();  // è·å–é€‰ä¸­çš„æŠ€èƒ½
    if (spellItem != null) {
        var spellData = ssm.getSelectedSpellData();
        if (spellData != SpellData.EMPTY) {
            var playerMagicData = MagicData.getPlayerMagicData(serverPlayer);

            // å¦‚æœæ­£åœ¨æ–½æ³•å…¶ä»–æŠ€èƒ½ï¼Œå–æ¶ˆå½“å‰æ–½æ³•
            if (playerMagicData.isCasting()
                && !playerMagicData.getCastingSpellId().equals(spellData.getSpell().getSpellId())) {
                ServerboundCancelCast.cancelCast(serverPlayer, ...);
            }

            // å°è¯•å¯åŠ¨æ–½æ³•
            return spellData.getSpell().attemptInitiateCast(
                ItemStack.EMPTY,
                spellData.getSpell().getLevelFor(spellData.getLevel(), serverPlayer),
                serverPlayer.level,
                serverPlayer,
                spellItem.getCastSource(),
                true,
                spellItem.slot
            );
        }
    }
    return false;
}

ServerboundQuickCast (å¿«é€Ÿæ–½æ³•)

ç”¨äºå¿«æ·é”®ç›´æ¥æ–½æ”¾æŠ€èƒ½ã€‚

ServerboundCancelCast (å–æ¶ˆæ–½æ³•)

ä¸­æ–­å½“å‰æ–½æ³•ã€‚

---
5.2 æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯

ClientboundUpdateCastingState (åŒæ­¥æ–½æ³•çŠ¶æ€)

public class ClientboundUpdateCastingState {
    private String spellId;
    private int spellLevel;
    private int castDuration;
    private CastSource castSource;
    private String castingEquipmentSlot;
}

ClientboundOnCastStarted (æ–½æ³•å¼€å§‹é€šçŸ¥)

é€šçŸ¥å…¶ä»–ç©å®¶æŸäººå¼€å§‹æ–½æ³•ï¼ˆç”¨äºåŠ¨ç”»ã€éŸ³æ•ˆï¼‰ã€‚

ClientboundOnCastFinished (æ–½æ³•ç»“æŸé€šçŸ¥)

é€šçŸ¥æ–½æ³•å®Œæˆæˆ–å–æ¶ˆã€‚

ClientboundOnClientCast (å®¢æˆ·ç«¯æ•ˆæœè§¦å‘)

public class ClientboundOnClientCast {
    private String spellId;
    private int spellLevel;
    private CastSource castSource;
    private ICastDataSerializable castData;  // åŒ…å«æŠ€èƒ½å‚æ•°
}

è§¦å‘å®¢æˆ·ç«¯çš„ onClientCast() æ–¹æ³•ï¼Œæ’­æ”¾ç‰¹æ•ˆå’ŒéŸ³æ•ˆã€‚

ClientboundSyncMana (åŒæ­¥é­”æ³•å€¼)

ClientboundSyncCooldown (åŒæ­¥å•ä¸ªå†·å´)

ClientboundSyncCooldowns (åŒæ­¥æ‰€æœ‰å†·å´)

---
6. æŒ‡ä»¤ç³»ç»Ÿ

6.1 CastCommand (æ–½æ³•æŒ‡ä»¤)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\com
mand\CastCommand.java

æŒ‡ä»¤æ ¼å¼ï¼š

/cast <casters> <spell> [level] [function]

å®ç°é€»è¾‘ï¼š

public static void register(CommandDispatcher<CommandSourceStack> dispatcher) {
    dispatcher.register(Commands.literal("cast")
        .requires((p) -> p.hasPermission(2))  // OP æƒé™
        .then(Commands.argument("casters", EntityArgument.entities())
            .then(Commands.argument("spell", SpellArgument.spellArgument())
                .executes((context) -> castSpell(context.getSource(),
                    EntityArgument.getEntities(context, "casters"),
                    context.getArgument("spell", String.class)))
                .then(Commands.argument("level", IntegerArgumentType.integer(1))
                    .executes((context) -> castSpell(..., IntegerArgumentType.getInteger(context,
"level"))))
                .then(Commands.argument("function value", FunctionArgument.functions())
                    .executes((context) -> castSpell(..., FunctionArgument.getFunctions(...))))
            ))
    );
}

æ–½æ³•æ‰§è¡Œï¼š

private static int castSpell(CommandSourceStack source, Collection<? extends Entity> targets,
                            String spellId, int spellLevel) {
    if (!spellId.contains(":")) {
        spellId = IronsSpellbooks.MODID + ":" + spellId;  // è‡ªåŠ¨è¡¥å…¨å‘½åç©ºé—´
    }

    var spell = SpellRegistry.getSpell(spellId);

    for (Entity target : targets) {
        if (target instanceof ServerPlayer serverPlayer) {
            spell.attemptInitiateCast(ItemStack.EMPTY, spellLevel, source.getLevel(),
                serverPlayer, CastSource.COMMAND, false, "command");
        } else if (target instanceof IMagicEntity castingMob) {
            castingMob.initiateCastSpell(spell, spellLevel);
        } else if (target instanceof LivingEntity livingEntity) {
            var magicData = MagicData.getPlayerMagicData(livingEntity);

            if (spell.checkPreCastConditions(source.getLevel(), spellLevel, livingEntity, magicData)) {
                spell.onCast(source.getLevel(), spellLevel, livingEntity,
                    CastSource.COMMAND, magicData);
                spell.onServerCastComplete(source.getLevel(), spellLevel,
                    livingEntity, magicData, false);
            }
        }
    }
    return 1;
}

---
6.2 SpellArgument (æŠ€èƒ½å‚æ•°ç±»å‹)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\com
mand\SpellArgument.java

æä¾›æŠ€èƒ½ ID çš„è‡ªåŠ¨è¡¥å…¨ï¼š
@Override
public <S> CompletableFuture<Suggestions> listSuggestions(
    final CommandContext<S> context, final SuggestionsBuilder builder) {

    var registeredSpells = SpellRegistry.REGISTRY.get().getEntries().stream()
        .map(entry -> {
            if (entry.getKey().location().getNamespace().equals(IronsSpellbooks.MODID)) {
                return entry.getKey().location().getPath();  // "firebolt"
            } else {
                return entry.getKey().location().toString();  // "addon:custom_spell"
            }
        })
        .sorted(...)
        .toList();

    return SharedSuggestionProvider.suggest(registeredSpells, builder);
}

ç¤ºä¾‹è¡¥å…¨ï¼š
/cast @s fire<TAB>
    â†’ firebolt, fireball, fire_breath, ...

---
6.3 å…¶ä»–æŒ‡ä»¤

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\reg
istries\CommandRegistry.java

@SubscribeEvent
public static void onCommandsRegister(RegisterCommandsEvent event) {
    var commandDispatcher = event.getDispatcher();

    CreateScrollCommand.register(commandDispatcher);         // åˆ›å»ºå·è½´
    CreateSpellBookCommand.register(commandDispatcher);      // åˆ›å»ºæ³•æœ¯ä¹¦
    CreateImbuedSwordCommand.register(commandDispatcher);    // åˆ›å»ºé™„é­”å‰‘
    CreateDebugWizardCommand.register(commandDispatcher);    // åˆ›å»ºæµ‹è¯•æ³•å¸ˆ
    CastCommand.register(commandDispatcher);                 // æ–½æ³•
    ManaCommand.register(commandDispatcher);                 // é­”æ³•å€¼ç®¡ç†
    LearnCommand.register(commandDispatcher);                // å­¦ä¹ æŠ€èƒ½
    ClearCooldownCommand.register(commandDispatcher);        // æ¸…é™¤å†·å´
    ClearRecastsCommand.register(commandDispatcher);         // æ¸…é™¤é‡æ–½

    // è°ƒè¯•æŒ‡ä»¤ï¼ˆä»…éç”Ÿäº§ç¯å¢ƒï¼‰
    if (!FMLLoader.isProduction()) {
        ClearSpellSelectionCommand.register(commandDispatcher);
        IronsDebugCommand.register(commandDispatcher);
    }
}

---
7. æŒ‰é”®è§¦å‘ä¸å®¢æˆ·ç«¯äº¤äº’

7.1 ClientInputEvents (å®¢æˆ·ç«¯è¾“å…¥å¤„ç†)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\pla
yer\ClientInputEvents.java

å…³é”®æŒ‰é”®çŠ¶æ€ï¼š

private static final KeyState SPELL_WHEEL_STATE = register(KeyMappings.SPELL_WHEEL_KEYMAP);
private static final KeyState SPELLBAR_MODIFIER_STATE =
register(KeyMappings.SPELLBAR_SCROLL_MODIFIER_KEYMAP);
private static final KeyState SPELLBOOK_CAST_STATE = register(SPELLBOOK_CAST_ACTIVE_KEYMAP);
private static final List<KeyState> QUICK_CAST_STATES = registerQuickCast(KeyMappings.QUICK_CAST_MAPPINGS);

public static boolean isUseKeyDown;            // å³é”®æ˜¯å¦æŒ‰ä¸‹
public static boolean hasReleasedSinceCasting; // æ–½æ³•åæ˜¯å¦é‡Šæ”¾è¿‡å³é”®
public static boolean isShiftKeyDown;          // Shift æ˜¯å¦æŒ‰ä¸‹

é¼ æ ‡æ»šè½®é€‰æ‹©æŠ€èƒ½ï¼š

@SubscribeEvent
public static void clientMouseScrolled(InputEvent.MouseScrollingEvent event) {
    if (Minecraft.getInstance().screen == null) {
        if (SPELLBAR_MODIFIER_STATE.isHeld()) {  // æŒ‰ä½ä¿®é¥°é”® + æ»šè½®
            SpellSelectionManager spellSelectionManager = ClientMagicData.getSpellSelectionManager();
            if (spellSelectionManager.getSpellCount() > 0) {
                int direction = Mth.clamp((int) event.getScrollDelta(), -1, 1);
                List<SpellSelectionManager.SelectionOption> spellbookSpells =
                    spellSelectionManager.getAllSpells();
                int spellCount = spellbookSpells.size();
                int scrollIndex = (Mth.clamp(spellSelectionManager.getSelectionIndex(), 0, spellCount) -
direction);
                int selectedIndex = (Mth.clamp(scrollIndex, -1, spellCount + 1) + spellCount) % spellCount;
                spellSelectionManager.makeSelection(selectedIndex);
                event.setCanceled(true);
            }
        }
    }
}

å³é”®äº¤äº’æ‹¦æˆªï¼š

@SubscribeEvent
public static void onUseInput(InputEvent.InteractionKeyMappingTriggered event) {
    if (event.isUseItem()) {
        if (ClientSpellCastHelper.shouldSuppressRightClicks()) {
            event.setSwingHand(false);
            event.setCanceled(true);  // é˜»æ­¢å³é”®ä½¿ç”¨ç‰©å“
        }
    } else if (event.isAttack()) {
        if (ClientMagicData.isCasting()) {
            event.setSwingHand(false);
            event.setCanceled(true);  // æ–½æ³•æ—¶é˜»æ­¢æ”»å‡»
        }
    }
}

---
7.2 æ–½æ³•è§¦å‘æµç¨‹

å®¢æˆ·ç«¯æŒ‰é”® â†’ æœåŠ¡ç«¯æ‰§è¡Œï¼š

1. ç©å®¶æŒ‰ä¸‹æ–½æ³•é”® (é»˜è®¤ R æˆ–å¿«æ·é”®)
2. å®¢æˆ·ç«¯å‘é€ ServerboundCast ç½‘ç»œåŒ…
3. æœåŠ¡ç«¯æ¥æ”¶å¹¶è°ƒç”¨ Utils.serverSideInitiateCast()
4. è·å–é€‰ä¸­æŠ€èƒ½ (SpellSelectionManager)
5. è°ƒç”¨ spell.attemptInitiateCast()
6. éªŒè¯æ¡ä»¶ï¼šé­”æ³•å€¼ã€å†·å´ã€æ–½æ³•é™åˆ¶
7. è§¦å‘äº‹ä»¶ SpellPreCastEvent
8. åˆå§‹åŒ–æ–½æ³•çŠ¶æ€ (playerMagicData.initiateCast())
9. åŒæ­¥å®¢æˆ·ç«¯ (ClientboundUpdateCastingState)
10. è°ƒç”¨ spell.onServerPreCast() (æœåŠ¡ç«¯é¢„æ–½æ³•é’©å­)

æ–½æ³•å®Œæˆæµç¨‹:

11. MagicManager.tick() æ¯ tick æ£€æŸ¥æ–½æ³•çŠ¶æ€
12. å€’è®¡æ—¶ castDurationRemaining--
13. æ—¶é—´åˆ°è¾¾æ—¶è°ƒç”¨ spell.castSpell()
14. è§¦å‘äº‹ä»¶ SpellOnCastEvent
15. æ‰£é™¤é­”æ³•å€¼
16. æ‰§è¡Œ spell.onCast() (ä¸»è¦é€»è¾‘)
17. æ·»åŠ å†·å´ MagicHelper.MAGIC_MANAGER.addCooldown()
18. åŒæ­¥å®¢æˆ·ç«¯ ClientboundOnClientCast
19. å®¢æˆ·ç«¯æ‰§è¡Œ spell.onClientCast() (ç‰¹æ•ˆã€éŸ³æ•ˆ)
20. è°ƒç”¨ spell.onServerCastComplete() (æ¸…ç†çŠ¶æ€)

---
8. Recast ç³»ç»Ÿ (é‡æ–½/è¿å‡»æœºåˆ¶)

8.1 RecastInstance (é‡æ–½å®ä¾‹)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\cap
abilities\magic\RecastInstance.java

public class RecastInstance implements ISerializable, INBTSerializable<CompoundTag> {
    protected String spellId;                   // æŠ€èƒ½ ID
    protected int spellLevel;                   // æŠ€èƒ½ç­‰çº§
    protected int remainingRecasts;             // å‰©ä½™å¯é‡æ–½æ¬¡æ•°
    protected int totalRecasts;                 // æ€»é‡æ–½æ¬¡æ•°
    protected ICastDataSerializable castData;   // æŠ€èƒ½å‚æ•°æ•°æ®
    protected int ticksToLive;                  // æ€»å­˜æ´»æ—¶é—´
    protected int remainingTicks;               // å‰©ä½™å­˜æ´»æ—¶é—´
    protected CastSource castSource;            // æ–½æ³•æ¥æº
}

8.2 ä½¿ç”¨åœºæ™¯

ç¤ºä¾‹ 1: Portal æŠ€èƒ½ (ä¼ é€é—¨)
- æ–½æ”¾åè¿›å…¥ Recast çŠ¶æ€
- å†æ¬¡æ–½æ”¾æ—¶ä¼ é€åˆ°ä¼ é€é—¨ä½ç½®
- castData åŒ…å«ä¼ é€é—¨åæ ‡ã€ç»´åº¦ç­‰ä¿¡æ¯

ç¤ºä¾‹ 2: Fire Wall æŠ€èƒ½ (ç«å¢™)
- å¯è¿ç»­æ–½æ”¾å¤šæ®µç«å¢™
- æ¯æ¬¡æ–½æ”¾æ¶ˆè€—ä¸€æ¬¡ Recast æ¬¡æ•°
- castData åŒ…å«å¢™ä½“æ—‹è½¬è§’åº¦ç­‰å‚æ•°

ç¤ºä¾‹ 3: Multi-hit Skills (è¿å‡»æŠ€èƒ½)
- çŸ­æ—¶é—´å†…å¯è¿ç»­æ–½æ”¾å¤šæ¬¡
- ä¸æ¶ˆè€—é­”æ³•å€¼ï¼ˆé¦–æ¬¡æ–½æ”¾å·²æ‰£é™¤ï¼‰
- ä¸è§¦å‘å†·å´ï¼ˆæœ€åä¸€æ¬¡æ–½æ”¾æ—¶æ‰è§¦å‘ï¼‰

8.3 æŠ€èƒ½å®ç°ç¤ºä¾‹

public class PortalSpell extends AbstractSpell {
    @Override
    public ICastDataSerializable getEmptyCastData() {
        return new PortalData();  // è‡ªå®šä¹‰æ•°æ®ç±»å‹
    }

    @Override
    public int getRecastCount(int spellLevel, @Nullable LivingEntity entity) {
        return 1;  // å¯é‡æ–½ 1 æ¬¡
    }

    @Override
    public void onCast(Level level, int spellLevel, LivingEntity entity,
                        CastSource castSource, MagicData playerMagicData) {
        var playerRecasts = playerMagicData.getPlayerRecasts();

        if (!playerRecasts.hasRecastForSpell(getSpellId())) {
            // é¦–æ¬¡æ–½æ”¾ï¼šåˆ›å»ºä¼ é€é—¨ï¼Œæ·»åŠ  Recast
            PortalEntity portal = new PortalEntity(level, entity.position());
            level.addFreshEntity(portal);

            int ticksToLive = 20 * 60;  // 60 ç§’æœ‰æ•ˆæœŸ
            playerRecasts.addRecast(new RecastInstance(
                getSpellId(),
                spellLevel,
                getRecastCount(spellLevel, entity),
                ticksToLive,
                castSource,
                new PortalData(portal.position(), level.dimension())
            ), (ServerPlayer) entity);
        } else {
            // ç¬¬äºŒæ¬¡æ–½æ”¾ï¼šä¼ é€å¹¶ç»“æŸ Recast
            var recast = playerRecasts.getRecastInstance(getSpellId());
            if (recast != null && recast.getCastData() instanceof PortalData portalData) {
                // ä¼ é€ç©å®¶åˆ°ä¼ é€é—¨ä½ç½®
                entity.teleportTo(portalData.getPortalPosition());

                // ç»“æŸ Recast
                playerRecasts.removeRecast(getSpellId(), (ServerPlayer) entity);
            }
        }

        super.onCast(level, spellLevel, entity, castSource, playerMagicData);
    }

    @Override
    public void onRecastFinished(ServerPlayer serverPlayer, RecastInstance recastInstance,
                                RecastResult recastResult, ICastDataSerializable castDataSerializable) {
        // Recast è¶…æ—¶æˆ–æ‰‹åŠ¨ç»“æŸæ—¶è°ƒç”¨
        if (castDataSerializable instanceof PortalData portalData) {
            // æ¸…ç†ä¼ é€é—¨å®ä½“
            portalData.removePortal(serverPlayer.serverLevel());
        }
        super.onRecastFinished(serverPlayer, recastInstance, recastResult, castDataSerializable);
    }
}

---
9. é…ç½®ç³»ç»Ÿ

9.1 ServerConfigs (æœåŠ¡ç«¯é…ç½®)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\con
fig\ServerConfigs.java

å…¨å±€é…ç½®ï¼š

public static final ForgeConfigSpec.ConfigValue<Boolean> SWORDS_CONSUME_MANA;
public static final ForgeConfigSpec.ConfigValue<Double> SWORDS_CD_MULTIPLIER;
public static final ForgeConfigSpec.ConfigValue<Boolean> CAN_ATTACK_OWN_SUMMONS;
public static final ForgeConfigSpec.ConfigValue<Integer> MAX_UPGRADES;
public static final ForgeConfigSpec.ConfigValue<Double> MANA_SPAWN_PERCENT;
public static final ForgeConfigSpec.ConfigValue<Double> SCROLL_RECYCLE_CHANCE;
public static final ForgeConfigSpec.ConfigValue<Boolean> SCROLL_MERGING;
public static final ForgeConfigSpec.ConfigValue<Boolean> SPELL_GREIFING;
public static final ForgeConfigSpec.ConfigValue<Boolean> DISABLE_ADVENTURE_MODE_CASTING;

æŠ€èƒ½é…ç½®ï¼š

private static final Map<String, SpellConfigParameters> SPELL_CONFIGS = new HashMap<>();

public static SpellConfigParameters getSpellConfig(AbstractSpell spell) {
    return SPELL_CONFIGS.getOrDefault(spell.getSpellId(), DEFAULT_CONFIG);
}

---
9.2 SpellConfigParameters (æŠ€èƒ½é…ç½®å‚æ•°)

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\con
fig\SpellConfigParameters.java

public class SpellConfigParameters {
    public final int MAX_LEVEL;               // æœ€å¤§ç­‰çº§
    public final SpellRarity MIN_RARITY;      // æœ€å°ç¨€æœ‰åº¦
    public final double MANA_MULTIPLIER;      // é­”æ³•æ¶ˆè€—å€ç‡
    public final double POWER_MULTIPLIER;     // å¨åŠ›å€ç‡
    public final double COOLDOWN_IN_SECONDS;  // å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
    public final boolean ENABLED;             // æ˜¯å¦å¯ç”¨
    public final boolean CAN_BE_CRAFTED;      // æ˜¯å¦å¯åˆ¶ä½œ
}

---
9.3 DefaultConfig (æŠ€èƒ½é»˜è®¤é…ç½®)

æ¯ä¸ªæŠ€èƒ½ç±»å†…éƒ¨å®šä¹‰ï¼š
@AutoSpellConfig
public class FireboltSpell extends AbstractSpell {
    private final DefaultConfig defaultConfig = new DefaultConfig()
        .setMinRarity(SpellRarity.COMMON)
        .setSchoolResource(SchoolRegistry.FIRE_RESOURCE)
        .setMaxLevel(10)
        .setCooldownSeconds(1)
        .build();

    @Override
    public DefaultConfig getDefaultConfig() {
        return defaultConfig;
    }
}

é…ç½®æ–‡ä»¶è·¯å¾„ï¼šconfig/irons_spellbooks-server.toml

---
10. æŠ€èƒ½å®ç°ç¤ºä¾‹è§£æ

10.1 Firebolt (ç«çƒæœ¯) - INSTANT ç¬å‘æŠ€èƒ½

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\spe
lls\fire\FireboltSpell.java

@AutoSpellConfig
public class FireboltSpell extends AbstractSpell {
    private final ResourceLocation spellId =
        ResourceLocation.fromNamespaceAndPath(IronsSpellbooks.MODID, "firebolt");

    // æŠ€èƒ½é…ç½®
    private final DefaultConfig defaultConfig = new DefaultConfig()
        .setMinRarity(SpellRarity.COMMON)
        .setSchoolResource(SchoolRegistry.FIRE_RESOURCE)
        .setMaxLevel(10)
        .setCooldownSeconds(1)
        .build();

    // æŠ€èƒ½åŸºç¡€å‚æ•°
    public FireboltSpell() {
        this.manaCostPerLevel = 2;       // æ¯çº§é­”æ³•æ¶ˆè€— +2
        this.baseSpellPower = 12;        // åŸºç¡€å¨åŠ› 12
        this.spellPowerPerLevel = 1;     // æ¯çº§å¨åŠ› +1
        this.castTime = 0;               // ç¬å‘ï¼ˆæ— æ–½æ³•æ—¶é—´ï¼‰
        this.baseManaCost = 10;          // åŸºç¡€é­”æ³•æ¶ˆè€— 10
    }

    @Override
    public CastType getCastType() {
        return CastType.INSTANT;  // ç¬å‘ç±»å‹
    }

    @Override
    public ResourceLocation getSpellResource() {
        return spellId;
    }

    @Override
    public DefaultConfig getDefaultConfig() {
        return defaultConfig;
    }

    // ä¸»è¦æ–½æ³•é€»è¾‘
    @Override
    public void onCast(Level world, int spellLevel, LivingEntity entity,
                        CastSource castSource, MagicData playerMagicData) {
        // 1. åˆ›å»ºç«çƒå¼¹ä¸¸å®ä½“
        FireboltProjectile firebolt = new FireboltProjectile(world, entity);

        // 2. è®¾ç½®åˆå§‹ä½ç½®ï¼ˆæ–½æ³•è€…çœ¼ç›é«˜åº¦ï¼‰
        firebolt.setPos(entity.position().add(
            0,
            entity.getEyeHeight() - firebolt.getBoundingBox().getYsize() * .5f,
            0
        ));

        // 3. å‘å°„å¼¹ä¸¸ï¼ˆæ²¿æ–½æ³•è€…è§†çº¿æ–¹å‘ï¼‰
        firebolt.shoot(entity.getLookAngle());

        // 4. è®¾ç½®ä¼¤å®³å€¼
        firebolt.setDamage(getDamage(spellLevel, entity));

        // 5. æ·»åŠ åˆ°ä¸–ç•Œ
        world.addFreshEntity(firebolt);

        // 6. è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼ˆæ’­æ”¾éŸ³æ•ˆï¼‰
        super.onCast(world, spellLevel, entity, castSource, playerMagicData);
    }

    // ä¼¤å®³è®¡ç®—
    private float getDamage(int spellLevel, LivingEntity entity) {
        return getSpellPower(spellLevel, entity) * .5f;
        // ä¾‹ï¼šç­‰çº§ 5 æ—¶ï¼Œå¨åŠ› = 12 + 1*4 = 16
        // ä¼¤å®³ = 16 * 0.5 * ç©å®¶å±æ€§åŠ æˆ
    }

    // è‡ªå®šä¹‰ä¼¤å®³æºï¼ˆé™„åŠ ç‡ƒçƒ§æ•ˆæœï¼‰
    @Override
    public SpellDamageSource getDamageSource(@Nullable Entity projectile, Entity attacker) {
        return super.getDamageSource(projectile, attacker).setFireTime(3);  // 3 ç§’ç‡ƒçƒ§
    }

    // UI æ˜¾ç¤ºä¿¡æ¯
    @Override
    public List<MutableComponent> getUniqueInfo(int spellLevel, LivingEntity caster) {
        return List.of(Component.translatable("ui.irons_spellbooks.damage",
            Utils.stringTruncation(getDamage(spellLevel, caster), 2)));
    }
}

---
10.2 Heal (æ²»ç–—æœ¯) - INSTANT ç¬å‘æŠ€èƒ½

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\spe
lls\holy\HealSpell.java

@AutoSpellConfig
public class HealSpell extends AbstractSpell {
    private final ResourceLocation spellId =
        ResourceLocation.fromNamespaceAndPath(IronsSpellbooks.MODID, "heal");

    private final DefaultConfig defaultConfig = new DefaultConfig()
        .setMinRarity(SpellRarity.UNCOMMON)
        .setSchoolResource(SchoolRegistry.HOLY_RESOURCE)
        .setMaxLevel(8)
        .setCooldownSeconds(30)
        .build();

    public HealSpell() {
        this.manaCostPerLevel = 15;
        this.baseSpellPower = 5;
        this.spellPowerPerLevel = 1;
        this.castTime = 0;
        this.baseManaCost = 30;
    }

    @Override
    public CastType getCastType() {
        return CastType.INSTANT;
    }

    @Override
    public void onCast(Level world, int spellLevel, LivingEntity entity,
                        CastSource castSource, MagicData playerMagicData) {
        // 1. è®¡ç®—æ²»ç–—é‡
        float healAmount = getSpellPower(spellLevel, entity);

        // 2. è§¦å‘æ²»ç–—äº‹ä»¶
        MinecraftForge.EVENT_BUS.post(new SpellHealEvent(entity, entity, healAmount, getSchoolType()));

        // 3. æ‰§è¡Œæ²»ç–—
        entity.heal(healAmount);

        // 4. æ’­æ”¾ç²’å­æ•ˆæœï¼ˆåœ†å½¢å¿ƒå½¢ç²’å­ï¼‰
        int count = 16;
        float radius = 1.25f;
        for (int i = 0; i < count; i++) {
            double theta = Math.toRadians(360 / count) * i;
            double x = Math.cos(theta) * radius;
            double z = Math.sin(theta) * radius;
            MagicManager.spawnParticles(world, ParticleTypes.HEART,
                entity.position().x + x,
                entity.position().y,
                entity.position().z + z,
                1, 0, 0, 0, 0.1, false);
        }

        super.onCast(world, spellLevel, entity, castSource, playerMagicData);
    }

    @Override
    public AnimationHolder getCastStartAnimation() {
        return SpellAnimations.SELF_CAST_ANIMATION;  // è‡ªæˆ‘æ–½æ³•åŠ¨ç”»
    }

    @Override
    public List<MutableComponent> getUniqueInfo(int spellLevel, LivingEntity caster) {
        return List.of(Component.translatable("ui.irons_spellbooks.healing",
            Utils.stringTruncation(getSpellPower(spellLevel, caster), 1)));
    }
}

---
10.3 Root (æ ¹é¡»ç¼ ç»•) - éœ€è¦ç›®æ ‡çš„æŠ€èƒ½

ä½ç½®: .\src\main\java\io\redspace\ironsspellbooks\spe
lls\nature\RootSpell.java

@AutoSpellConfig
public class RootSpell extends AbstractSpell {
    // ... é…ç½®çœç•¥ ...

    // å‰ç½®æ¡ä»¶ï¼šå¿…é¡»é€‰ä¸­ç›®æ ‡
    @Override
    public boolean checkPreCastConditions(Level level, int spellLevel,
                                        LivingEntity entity, MagicData playerMagicData) {
        return Utils.preCastTargetHelper(level, entity, playerMagicData, this, 32, .35f);
        // å‚æ•°ï¼šlevel, æ–½æ³•è€…, é­”æ³•æ•°æ®, æŠ€èƒ½, æœ€å¤§è·ç¦», ç„å‡†è¾…åŠ©èŒƒå›´
        // æ­¤æ–¹æ³•ä¼šè‡ªåŠ¨ï¼š
        // 1. å°„çº¿æ£€æµ‹ç›®æ ‡
        // 2. è®¾ç½® TargetEntityCastData åˆ° playerMagicData
        // 3. å‘é€å®¢æˆ·ç«¯ç„å‡†åŒæ­¥
        // 4. æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    }

    @Override
    public void onCast(Level level, int spellLevel, LivingEntity entity,
                        CastSource castSource, MagicData playerMagicData) {
        // è·å–ç›®æ ‡å®ä½“
        if (playerMagicData.getAdditionalCastData() instanceof TargetEntityCastData castTargetingData) {
            var targetEntity = castTargetingData.getTarget((ServerLevel) level);

            if (targetEntity != null) {
                // å¯¹ç›®æ ‡æ–½åŠ æ ¹é¡»æ•ˆæœ
                int duration = getDuration(spellLevel);
                int amplifier = getAmplifier(spellLevel);
                targetEntity.addEffect(new MobEffectInstance(
                    MobEffectRegistry.ROOT.get(),
                    duration,
                    amplifier
                ));

                // ç²’å­æ•ˆæœ
                MagicManager.spawnParticles(level, ParticleTypes.SNEEZE,
                    targetEntity.getX(),
                    targetEntity.getY() + targetEntity.getBbHeight() * 0.5,
                    targetEntity.getZ(),
                    25,
                    targetEntity.getBbWidth() * 0.5,
                    targetEntity.getBbHeight() * 0.5,
                    targetEntity.getBbWidth() * 0.5,
                    0.03, true);
            }
        }

        super.onCast(level, spellLevel, entity, castSource, playerMagicData);
    }

    private int getDuration(int spellLevel) {
        return 100 + 20 * spellLevel;  // 5 ç§’åŸºç¡€ + æ¯çº§ 1 ç§’
    }

    private int getAmplifier(int spellLevel) {
        return spellLevel / 3;  // æ¯ 3 çº§ +1 å¼ºåº¦
    }
}

---
11. æŠ€èƒ½å‚æ•°ä¼ é€’å®Œæ•´æµç¨‹ç¤ºä¾‹

åœºæ™¯ï¼šä¼ é€é—¨æŠ€èƒ½ (Portal Spell)

éœ€æ±‚ï¼š
1. é¦–æ¬¡æ–½æ”¾ï¼šåœ¨ç›®æ ‡ä½ç½®åˆ›å»ºä¼ é€é—¨
2. äºŒæ¬¡æ–½æ”¾ï¼šä¼ é€åˆ°ä¼ é€é—¨ä½ç½®
3. ä¼ é€é—¨æœ‰ 60 ç§’æœ‰æ•ˆæœŸ

å®ç°æ­¥éª¤ï¼š

æ­¥éª¤ 1ï¼šå®šä¹‰è‡ªå®šä¹‰ CastData

public class PortalData implements ICastDataSerializable {
    private Vec3 portalPosition;
    private ResourceKey<Level> dimension;
    private UUID portalEntityUUID;

    public PortalData() {}

    public PortalData(Vec3 position, ResourceKey<Level> dimension) {
        this.portalPosition = position;
        this.dimension = dimension;
    }

    @Override
    public void writeToBuffer(FriendlyByteBuf buffer) {
        buffer.writeDouble(portalPosition.x);
        buffer.writeDouble(portalPosition.y);
        buffer.writeDouble(portalPosition.z);
        buffer.writeResourceKey(dimension);
        buffer.writeUUID(portalEntityUUID);
    }

    @Override
    public void readFromBuffer(FriendlyByteBuf buffer) {
        portalPosition = new Vec3(buffer.readDouble(), buffer.readDouble(), buffer.readDouble());
        dimension = buffer.readResourceKey(Registries.DIMENSION);
        portalEntityUUID = buffer.readUUID();
    }

    @Override
    public CompoundTag serializeNBT() {
        var tag = new CompoundTag();
        tag.putDouble("px", portalPosition.x);
        tag.putDouble("py", portalPosition.y);
        tag.putDouble("pz", portalPosition.z);
        tag.putString("dim", dimension.location().toString());
        tag.putUUID("uuid", portalEntityUUID);
        return tag;
    }

    @Override
    public void deserializeNBT(CompoundTag tag) {
        portalPosition = new Vec3(tag.getDouble("px"), tag.getDouble("py"), tag.getDouble("pz"));
        dimension = ResourceKey.create(Registries.DIMENSION, new ResourceLocation(tag.getString("dim")));
        portalEntityUUID = tag.getUUID("uuid");
    }

    @Override
    public void reset() {
        // æ¸…ç†ä¼ é€é—¨å®ä½“
    }
}

æ­¥éª¤ 2ï¼šæŠ€èƒ½ç±»å®ç°

public class PortalSpell extends AbstractSpell {
    @Override
    public ICastDataSerializable getEmptyCastData() {
        return new PortalData();  // æä¾›ç©ºæ•°æ®å®ä¾‹
    }

    @Override
    public int getRecastCount(int spellLevel, @Nullable LivingEntity entity) {
        return 1;  // å…è®¸é‡æ–½ 1 æ¬¡
    }

    @Override
    public boolean checkPreCastConditions(Level level, int spellLevel,
                                        LivingEntity entity, MagicData playerMagicData) {
        var playerRecasts = playerMagicData.getPlayerRecasts();

        // å¦‚æœå·²æœ‰ä¼ é€é—¨ï¼Œæ— éœ€ç›®æ ‡æ£€æµ‹
        if (playerRecasts.hasRecastForSpell(getSpellId())) {
            return true;
        }

        // é¦–æ¬¡æ–½æ”¾ï¼šéœ€è¦é€‰æ‹©ç›®æ ‡ä½ç½®
        return Utils.preCastTargetHelper(level, entity, playerMagicData, this, 48, .25f, false);
    }

    @Override
    public void onCast(Level level, int spellLevel, LivingEntity entity,
                        CastSource castSource, MagicData playerMagicData) {
        var playerRecasts = playerMagicData.getPlayerRecasts();

        if (!playerRecasts.hasRecastForSpell(getSpellId())) {
            // ============ é¦–æ¬¡æ–½æ”¾ï¼šåˆ›å»ºä¼ é€é—¨ ============
            Vec3 targetPosition = null;

            // è·å–ç›®æ ‡ä½ç½®
            if (playerMagicData.getAdditionalCastData() instanceof TargetEntityCastData castTargetingData) {
                targetPosition = castTargetingData.getTargetPosition((ServerLevel) level);
            }

            if (targetPosition == null) {
                targetPosition = entity.position();  // é»˜è®¤å½“å‰ä½ç½®
            }

            // åˆ›å»ºä¼ é€é—¨å®ä½“
            PortalEntity portalEntity = new PortalEntity(level, targetPosition);
            level.addFreshEntity(portalEntity);

            // åˆ›å»º Recast æ•°æ®
            PortalData portalData = new PortalData(
                targetPosition,
                level.dimension()
            );
            portalData.portalEntityUUID = portalEntity.getUUID();

            // æ·»åŠ  Recast
            int ticksToLive = 20 * 60;  // 60 ç§’æœ‰æ•ˆæœŸ
            playerRecasts.addRecast(new RecastInstance(
                getSpellId(),
                spellLevel,
                getRecastCount(spellLevel, entity),
                ticksToLive,
                castSource,
                portalData
            ), (ServerPlayer) entity);

            // æç¤ºç©å®¶
            if (entity instanceof ServerPlayer serverPlayer) {
                serverPlayer.connection.send(new ClientboundSetActionBarTextPacket(
                    Component.translatable("ui.irons_spellbooks.portal_created")
                        .withStyle(ChatFormatting.GREEN)
                ));
            }

        } else {
            // ============ äºŒæ¬¡æ–½æ”¾ï¼šä¼ é€åˆ°ä¼ é€é—¨ ============
            var recast = playerRecasts.getRecastInstance(getSpellId());

            if (recast != null && recast.getCastData() instanceof PortalData portalData) {
                // è·å–ä¼ é€é—¨ä½ç½®
                Vec3 portalPos = portalData.portalPosition;
                ResourceKey<Level> portalDim = portalData.dimension;

                // è·¨ç»´åº¦ä¼ é€
                if (!level.dimension().equals(portalDim)) {
                    if (entity instanceof ServerPlayer serverPlayer) {
                        ServerLevel targetLevel = level.getServer().getLevel(portalDim);
                        if (targetLevel != null) {
                            serverPlayer.teleportTo(targetLevel,
                                portalPos.x, portalPos.y, portalPos.z,
                                serverPlayer.getYRot(), serverPlayer.getXRot());
                        }
                    }
                } else {
                    // åŒç»´åº¦ä¼ é€
                    entity.teleportTo(portalPos.x, portalPos.y, portalPos.z);
                }

                // ç§»é™¤ Recast
                playerRecasts.removeRecast(getSpellId(), (ServerPlayer) entity);

                // ç²’å­æ•ˆæœ
                MagicManager.spawnParticles(level, ParticleTypes.PORTAL,
                    entity.getX(), entity.getY() + 1, entity.getZ(),
                    50, 0.5, 1, 0.5, 0.1, true);
            }
        }

        super.onCast(level, spellLevel, entity, castSource, playerMagicData);
    }

    @Override
    public void onRecastFinished(ServerPlayer serverPlayer, RecastInstance recastInstance,
                                RecastResult recastResult, ICastDataSerializable castDataSerializable) {
        // Recast è¶…æ—¶æ—¶è‡ªåŠ¨æ¸…ç†ä¼ é€é—¨
        if (castDataSerializable instanceof PortalData portalData) {
            ServerLevel level = serverPlayer.serverLevel();
            Entity portalEntity = level.getEntity(portalData.portalEntityUUID);
            if (portalEntity != null) {
                portalEntity.discard();  // ç§»é™¤ä¼ é€é—¨å®ä½“
            }

            // æç¤ºç©å®¶
            serverPlayer.connection.send(new ClientboundSetActionBarTextPacket(
                Component.translatable("ui.irons_spellbooks.portal_expired")
                    .withStyle(ChatFormatting.RED)
            ));
        }

        super.onRecastFinished(serverPlayer, recastInstance, recastResult, castDataSerializable);
    }
}

æ­¥éª¤ 3ï¼šæ•°æ®æµè½¬è¿‡ç¨‹

é¦–æ¬¡æ–½æ”¾ï¼š
1. ç©å®¶æŒ‰ä¸‹æ–½æ³•é”® â†’ ServerboundCast å‘é€
2. æœåŠ¡ç«¯è°ƒç”¨ checkPreCastConditions() â†’ preCastTargetHelper è®¾ç½® TargetEntityCastData
3. è°ƒç”¨ attemptInitiateCast() â†’ éªŒè¯é€šè¿‡
4. è°ƒç”¨ castSpell() â†’ è°ƒç”¨ onCast()
5. onCast() ä¸­ï¼š
    - ä» TargetEntityCastData è·å–ç›®æ ‡ä½ç½®
    - åˆ›å»º PortalEntity å®ä½“
    - åˆ›å»º PortalData åŒ…å«ä¼ é€é—¨ä½ç½®ã€ç»´åº¦ã€UUID
    - æ·»åŠ  RecastInstance åˆ° playerRecasts
    - åŒæ­¥å®¢æˆ·ç«¯ (ClientBoundSyncRecast)

äºŒæ¬¡æ–½æ”¾ï¼š
1. ç©å®¶å†æ¬¡æŒ‰ä¸‹æ–½æ³•é”® â†’ ServerboundCast å‘é€
2. æœåŠ¡ç«¯è°ƒç”¨ checkPreCastConditions() â†’ æ£€æµ‹åˆ°å·²æœ‰ Recastï¼Œè¿”å› true
3. è°ƒç”¨ onCast()ï¼š
    - ä» playerRecasts.getRecastInstance() è·å– RecastInstance
    - ä» RecastInstance.getCastData() è·å– PortalData
    - è¯»å–ä¼ é€é—¨ä½ç½®ã€ç»´åº¦
    - æ‰§è¡Œä¼ é€
    - è°ƒç”¨ playerRecasts.removeRecast() ç§»é™¤ Recast
    - åŒæ­¥å®¢æˆ·ç«¯ (ClientBoundRemoveRecast)

è¶…æ—¶æ¸…ç†ï¼š
1. PlayerRecasts.tick() æ¯ tick é€’å‡ remainingTicks
2. remainingTicks å½’é›¶æ—¶è°ƒç”¨ spell.onRecastFinished()
3. onRecastFinished() ä¸­ï¼š
    - è·å– PortalData
    - æ ¹æ® UUID æŸ¥æ‰¾å¹¶ç§»é™¤ PortalEntity
    - å‘é€è¶…æ—¶æç¤º

---
12. ç›®å½•ç»“æ„æ€»ç»“

io.redspace.ironsspellbooks/
â”œâ”€â”€ api/                                    # å…¬å…± API
â”‚   â”œâ”€â”€ spells/                            # æŠ€èƒ½æ ¸å¿ƒæ¥å£
â”‚   â”‚   â”œâ”€â”€ AbstractSpell.java             # æŠ€èƒ½æŠ½è±¡ç±» â˜…
â”‚   â”‚   â”œâ”€â”€ CastType.java                  # æ–½æ³•ç±»å‹æšä¸¾
â”‚   â”‚   â”œâ”€â”€ CastSource.java                # æ–½æ³•æ¥æºæšä¸¾
â”‚   â”‚   â”œâ”€â”€ CastResult.java                # æ–½æ³•ç»“æœ
â”‚   â”‚   â”œâ”€â”€ ICastData.java                 # æ–½æ³•æ•°æ®æ¥å£
â”‚   â”‚   â”œâ”€â”€ ICastDataSerializable.java     # å¯åºåˆ—åŒ–æ–½æ³•æ•°æ®
â”‚   â”‚   â”œâ”€â”€ SpellData.java                 # æŠ€èƒ½æ•°æ®ç±»
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ registry/                          # æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ SpellRegistry.java             # æŠ€èƒ½æ³¨å†Œè¡¨ â˜…
â”‚   â”‚   â”œâ”€â”€ SchoolRegistry.java            # å­¦æ´¾æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ AttributeRegistry.java         # å±æ€§æ³¨å†Œè¡¨
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ magic/                             # é­”æ³•ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ MagicData.java                 # ç©å®¶é­”æ³•æ•°æ® â˜…
â”‚   â”‚   â”œâ”€â”€ MagicHelper.java               # é­”æ³•å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â”œâ”€â”€ spells/                                # æŠ€èƒ½å®ç°
â”‚   â”œâ”€â”€ NoneSpell.java                     # ç©ºæŠ€èƒ½å ä½ç¬¦
â”‚   â”œâ”€â”€ EntityCastData.java                # å®ä½“æ–½æ³•æ•°æ®
â”‚   â”œâ”€â”€ TargetAreaCastData.java            # åŒºåŸŸæ–½æ³•æ•°æ®
â”‚   â”œâ”€â”€ blood/                             # è¡€é­”æ³•å­¦æ´¾
â”‚   â”‚   â”œâ”€â”€ BloodSlashSpell.java
â”‚   â”‚   â”œâ”€â”€ HeartstopSpell.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ fire/                              # ç«ç„°å­¦æ´¾
â”‚   â”‚   â”œâ”€â”€ FireboltSpell.java             # ç«çƒæœ¯ â˜…
â”‚   â”‚   â”œâ”€â”€ FireballSpell.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ holy/                              # ç¥åœ£å­¦æ´¾
â”‚   â”‚   â”œâ”€â”€ HealSpell.java                 # æ²»ç–—æœ¯ â˜…
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ ice/                               # å†°éœœå­¦æ´¾
â”‚   â”œâ”€â”€ lightning/                         # é›·ç”µå­¦æ´¾
â”‚   â”œâ”€â”€ nature/                            # è‡ªç„¶å­¦æ´¾
â”‚   â”‚   â”œâ”€â”€ RootSpell.java                 # æ ¹é¡»ç¼ ç»• â˜…
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ ender/                             # æœ«å½±å­¦æ´¾
â”‚   â”‚   â”œâ”€â”€ PortalSpell.java               # ä¼ é€é—¨ â˜…
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ evocation/                         # å’’æœ¯å­¦æ´¾
â”‚   â””â”€â”€ eldritch/                          # è¯¡æœ¯å­¦æ´¾
â”œâ”€â”€ capabilities/magic/                    # é­”æ³•èƒ½åŠ›ç³»ç»Ÿ
â”‚   â”œâ”€â”€ MagicManager.java                  # é­”æ³•ç®¡ç†å™¨ â˜…
â”‚   â”œâ”€â”€ PlayerCooldowns.java               # ç©å®¶å†·å´ç®¡ç†
â”‚   â”œâ”€â”€ PlayerRecasts.java                 # ç©å®¶é‡æ–½ç®¡ç†
â”‚   â”œâ”€â”€ RecastInstance.java                # é‡æ–½å®ä¾‹ â˜…
â”‚   â”œâ”€â”€ TargetEntityCastData.java          # ç›®æ ‡å®ä½“æ•°æ® â˜…
â”‚   â”œâ”€â”€ ImpulseCastData.java               # å†²åˆºæ•°æ®
â”‚   â”œâ”€â”€ MultiTargetEntityCastData.java     # å¤šç›®æ ‡æ•°æ®
â”‚   â”œâ”€â”€ SyncedSpellData.java               # åŒæ­¥æ•°æ®
â”‚   â””â”€â”€ ...
â”œâ”€â”€ network/                               # ç½‘ç»œé€šä¿¡
â”‚   â”œâ”€â”€ ServerboundCast.java               # å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ï¼šæ–½æ³•è¯·æ±‚ â˜…
â”‚   â”œâ”€â”€ ServerboundQuickCast.java          # å¿«é€Ÿæ–½æ³•
â”‚   â”œâ”€â”€ ServerboundCancelCast.java         # å–æ¶ˆæ–½æ³•
â”‚   â”œâ”€â”€ ClientboundUpdateCastingState.java # æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ï¼šæ–½æ³•çŠ¶æ€
â”‚   â”œâ”€â”€ ClientboundOnCastStarted.java      # æ–½æ³•å¼€å§‹é€šçŸ¥
â”‚   â”œâ”€â”€ ClientboundOnCastFinished.java     # æ–½æ³•ç»“æŸé€šçŸ¥
â”‚   â”œâ”€â”€ ClientboundOnClientCast.java       # å®¢æˆ·ç«¯æ•ˆæœè§¦å‘ â˜…
â”‚   â”œâ”€â”€ ClientboundSyncMana.java           # åŒæ­¥é­”æ³•å€¼
â”‚   â”œâ”€â”€ ClientboundSyncCooldown.java       # åŒæ­¥å†·å´
â”‚   â”œâ”€â”€ ClientBoundSyncRecast.java         # åŒæ­¥é‡æ–½
â”‚   â””â”€â”€ ...
â”œâ”€â”€ command/                               # æŒ‡ä»¤ç³»ç»Ÿ
â”‚   â”œâ”€â”€ CastCommand.java                   # /cast æŒ‡ä»¤ â˜…
â”‚   â”œâ”€â”€ SpellArgument.java                 # æŠ€èƒ½å‚æ•°ç±»å‹ â˜…
â”‚   â”œâ”€â”€ ManaCommand.java                   # é­”æ³•å€¼æŒ‡ä»¤
â”‚   â”œâ”€â”€ LearnCommand.java                  # å­¦ä¹ æŠ€èƒ½
â”‚   â”œâ”€â”€ ClearCooldownCommand.java          # æ¸…é™¤å†·å´
â”‚   â””â”€â”€ ...
â”œâ”€â”€ player/                                # ç©å®¶äº¤äº’
â”‚   â”œâ”€â”€ ClientInputEvents.java             # å®¢æˆ·ç«¯è¾“å…¥å¤„ç† â˜…
â”‚   â”œâ”€â”€ ClientSpellCastHelper.java         # å®¢æˆ·ç«¯æ–½æ³•è¾…åŠ©
â”‚   â”œâ”€â”€ ClientMagicData.java               # å®¢æˆ·ç«¯é­”æ³•æ•°æ®
â”‚   â””â”€â”€ ...
â”œâ”€â”€ config/                                # é…ç½®ç³»ç»Ÿ
â”‚   â”œâ”€â”€ ServerConfigs.java                 # æœåŠ¡ç«¯é…ç½® â˜…
â”‚   â”œâ”€â”€ SpellConfigParameters.java         # æŠ€èƒ½é…ç½®å‚æ•° â˜…
â”‚   â””â”€â”€ ...
â”œâ”€â”€ registries/                            # æ³¨å†Œå™¨
â”‚   â”œâ”€â”€ CommandRegistry.java               # æŒ‡ä»¤æ³¨å†Œ â˜…
â”‚   â””â”€â”€ ...
â””â”€â”€ IronsSpellbooks.java                   # Mod ä¸»ç±» â˜…

---
13. å…³é”®æµç¨‹æ—¶åºå›¾

13.1 å®Œæ•´æ–½æ³•æµç¨‹

[ç©å®¶]            [å®¢æˆ·ç«¯]              [ç½‘ç»œ]              [æœåŠ¡ç«¯]                    [MagicManager]
    |                  |                    |                    |                              |
    | æŒ‰ä¸‹æ–½æ³•é”®        |                    |                    |                              |
    |----------------->|                    |                    |                              |
    |                  | ServerboundCast    |                    |                              |
    |                  |------------------->|                    |                              |
    |                  |                    | serverSideInitiateCast                            |
    |                  |                    |------------------->|                              |
    |                  |                    |                    | getSelectedSpellData()       |
    |                  |                    |                    |----------------------------->|
    |                  |                    |                    |                              |
    |                  |                    |                    | attemptInitiateCast()        |
    |                  |                    |                    |----------------------------->|
    |                  |                    |                    |   canBeCastedBy()            |
    |                  |                    |                    |   checkPreCastConditions()   |
    |                  |                    |                    |   SpellPreCastEvent          |
    |                  |                    |                    |   initiateCast()             |
    |                  |                    |                    |   onServerPreCast()          |
    |                  |                    |                    |                              |
    |                  | ClientboundUpdateCastingState                                          |
    |                  |<-------------------|                    |                              |
    | å¼€å§‹æ–½æ³•åŠ¨ç”»      |                    |                    |                              |
    |<-----------------|                    |                    |                              |
    |                  |                    |                    |                              |
    |   ... ç­‰å¾… castDuration ticks ...     |                    |                              |
    |                  |                    |                    |                              |
    |                  |                    |                    |   [æ¯ tick]                  |
    |                  |                    |                    |   MagicManager.tick()        |
    |                  |                    |                    |<-----------------------------|
    |                  |                    |                    |   handleCastDuration()       |
    |                  |                    |                    |   onServerCastTick()         |
    |                  |                    |                    |                              |
    |   ... castDurationRemaining == 0 ... |                    |                              |
    |                  |                    |                    |                              |
    |                  |                    |                    |   castSpell()                |
    |                  |                    |                    |<-----------------------------|
    |                  |                    |                    |   SpellOnCastEvent           |
    |                  |                    |                    |   æ‰£é™¤é­”æ³•å€¼                 |
    |                  |                    |                    |   onCast() â˜…                 |
    |                  |                    |                    |   addCooldown()              |
    |                  |                    |                    |   onServerCastComplete()     |
    |                  |                    |                    |                              |
    |                  | ClientboundOnClientCast                                                |
    |                  |<-------------------|                    |                              |
    |                  | onClientCast() â˜…   |                    |                              |
    |                  | (ç²’å­ã€éŸ³æ•ˆ)       |                    |                              |
    |                  |                    |                    |                              |
    |                  | ClientboundSyncMana|                    |                              |
    |                  |<-------------------|                    |                              |
    |                  | ClientboundSyncCooldown                                                |
    |                  |<-------------------|                    |                              |
    |                  |                    |                    |                              |

---
14. æ ¸å¿ƒ API å¿«é€Ÿå‚è€ƒ

14.1 è·å–æŠ€èƒ½å®ä¾‹

// é€šè¿‡ ID è·å–
AbstractSpell spell = SpellRegistry.getSpell("irons_spellbooks:firebolt");
AbstractSpell spell = SpellRegistry.getSpell(ResourceLocation.parse("irons_spellbooks:heal"));

// è·å–æ‰€æœ‰å¯ç”¨çš„æŠ€èƒ½
List<AbstractSpell> enabledSpells = SpellRegistry.getEnabledSpells();

// è·å–ç‰¹å®šå­¦æ´¾çš„æŠ€èƒ½
List<AbstractSpell> fireSpells = SpellRegistry.getSpellsForSchool(SchoolRegistry.FIRE.get());

---
14.2 è·å–ç©å®¶é­”æ³•æ•°æ®

// æœåŠ¡ç«¯
MagicData magicData = MagicData.getPlayerMagicData(serverPlayer);

// é­”æ³•å€¼æ“ä½œ
float currentMana = magicData.getMana();
magicData.setMana(100);
magicData.addMana(50);

// å†·å´æ“ä½œ
PlayerCooldowns cooldowns = magicData.getPlayerCooldowns();
boolean isOnCooldown = cooldowns.isOnCooldown(spell);
int remainingTicks = cooldowns.getCooldownPercent(spell);

// Recast æ“ä½œ
PlayerRecasts recasts = magicData.getPlayerRecasts();
boolean hasRecast = recasts.hasRecastForSpell("irons_spellbooks:portal");
RecastInstance recast = recasts.getRecastInstance("irons_spellbooks:portal");

---
14.3 æ‰‹åŠ¨è§¦å‘æ–½æ³•

// æ–¹å¼ 1ï¼šé€šè¿‡ç©å®¶ç›´æ¥æ–½æ”¾
AbstractSpell spell = SpellRegistry.getSpell("irons_spellbooks:firebolt");
int spellLevel = 5;
boolean success = spell.attemptInitiateCast(
    ItemStack.EMPTY,                    // æ–½æ³•ç‰©å“ï¼ˆå¯é€‰ï¼‰
    spellLevel,                         // æŠ€èƒ½ç­‰çº§
    serverPlayer.level,                 // ä¸–ç•Œ
    serverPlayer,                       // æ–½æ³•è€…
    CastSource.COMMAND,                 // æ–½æ³•æ¥æº
    true,                               // æ˜¯å¦è§¦å‘å†·å´
    "command"                           // æ–½æ³•æ§½ä½æ ‡è¯†
);

// æ–¹å¼ 2ï¼šç›´æ¥æ‰§è¡Œæ•ˆæœï¼ˆè·³è¿‡æ–½æ³•æ—¶é—´ï¼‰
MagicData magicData = MagicData.getPlayerMagicData(serverPlayer);
if (spell.checkPreCastConditions(level, spellLevel, serverPlayer, magicData)) {
    spell.onCast(level, spellLevel, serverPlayer, CastSource.COMMAND, magicData);
    spell.onServerCastComplete(level, spellLevel, serverPlayer, magicData, false);
}

---
14.4 è®¾ç½®æ–½æ³•å‚æ•°

// å•ç›®æ ‡æŠ€èƒ½
LivingEntity target = ...; // è·å–ç›®æ ‡å®ä½“
TargetEntityCastData targetData = new TargetEntityCastData(target);
magicData.setAdditionalCastData(targetData);

// åŒºåŸŸæŠ€èƒ½
Vec3 center = new Vec3(x, y, z);
TargetedAreaEntity areaEntity = new TargetedAreaEntity(...);
TargetAreaCastData areaData = new TargetAreaCastData(center, areaEntity);
magicData.setAdditionalCastData(areaData);

// ä½ç§»æŠ€èƒ½
Vec3 impulse = new Vec3(dx, dy, dz);
ImpulseCastData impulseData = new ImpulseCastData();
impulseData.setImpulse(impulse);
magicData.setAdditionalCastData(impulseData);

---
14.5 æ·»åŠ  Recast

// åˆ›å»ºè‡ªå®šä¹‰æ•°æ®
ICastDataSerializable customData = new MyCustomCastData(...);

// åˆ›å»º Recast å®ä¾‹
RecastInstance recast = new RecastInstance(
    spell.getSpellId(),                 // æŠ€èƒ½ ID
    spellLevel,                         // æŠ€èƒ½ç­‰çº§
    3,                                  // æ€»é‡æ–½æ¬¡æ•°
    20 * 30,                            // æœ‰æ•ˆæ—¶é—´ï¼ˆ30 ç§’ï¼‰
    CastSource.SPELLBOOK,               // æ–½æ³•æ¥æº
    customData                          // è‡ªå®šä¹‰æ•°æ®
);

// æ·»åŠ åˆ°ç©å®¶
magicData.getPlayerRecasts().addRecast(recast, serverPlayer);

---
14.6 é…ç½®æŸ¥è¯¢

// è·å–æŠ€èƒ½é…ç½®
int maxLevel = spell.getMaxLevel();
int cooldown = spell.getSpellCooldown();
int manaCost = spell.getManaCost(spellLevel);
float spellPower = spell.getSpellPower(spellLevel, caster);
boolean enabled = spell.isEnabled();

// è·å–å…¨å±€é…ç½®
boolean swordsConsumeMana = ServerConfigs.SWORDS_CONSUME_MANA.get();
double swordsCDMultiplier = ServerConfigs.SWORDS_CD_MULTIPLIER.get();
boolean spellGriefing = ServerConfigs.SPELL_GREIFING.get();

---
15. æ‰©å±•ä¸ Addon å¼€å‘å»ºè®®

15.1 åˆ›å»ºæ–°æŠ€èƒ½

1. ç»§æ‰¿ AbstractSpell
2. æ·»åŠ  @AutoSpellConfig æ³¨è§£
3. å®ç°å¿…éœ€æ–¹æ³•ï¼š
    - getSpellResource()
    - getDefaultConfig()
    - getCastType()
    - onCast()
4. æ³¨å†ŒæŠ€èƒ½ï¼š
public static final RegistryObject<AbstractSpell> MY_SPELL =
    SpellRegistry.registerSpell(new MyCustomSpell());

---
15.2 è‡ªå®šä¹‰æ–½æ³•å‚æ•°

1. å®ç° ICastDataSerializable æ¥å£
2. å®ç°åºåˆ—åŒ–æ–¹æ³•ï¼š
    - writeToBuffer(FriendlyByteBuf)
    - readFromBuffer(FriendlyByteBuf)
    - serializeNBT()
    - deserializeNBT(CompoundTag)
3. åœ¨æŠ€èƒ½ä¸­é‡å†™ getEmptyCastData()
4. åœ¨ onCast() ä¸­è¯»å–å‚æ•°

---
15.3 æŒ‡ä»¤é›†æˆ

// æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤
@SubscribeEvent
public static void onCommandsRegister(RegisterCommandsEvent event) {
    event.getDispatcher().register(Commands.literal("myspell")
        .requires((p) -> p.hasPermission(2))
        .then(Commands.argument("spell", SpellArgument.spellArgument())
            .executes((context) -> {
                String spellId = context.getArgument("spell", String.class);
                AbstractSpell spell = SpellRegistry.getSpell(spellId);
                // ... è‡ªå®šä¹‰é€»è¾‘
                return 1;
            })
        )
    );
}

---
15.4 äº‹ä»¶ç›‘å¬

@SubscribeEvent
public static void onSpellCast(SpellOnCastEvent event) {
    AbstractSpell spell = SpellRegistry.getSpell(event.getSpellId());
    LivingEntity caster = event.getEntity();
    int level = event.getSpellLevel();

    // ä¿®æ”¹é­”æ³•æ¶ˆè€—
    event.setManaCost(event.getManaCost() * 0.5f);

    // å–æ¶ˆæ–½æ³•
    // event.setCanceled(true);
}

@SubscribeEvent
public static void onPreCast(SpellPreCastEvent event) {
    // æ–½æ³•å‰æ£€æŸ¥
}

---
16. å¸¸è§é—®é¢˜ä¸æ³¨æ„äº‹é¡¹

Q1: å¦‚ä½•è®©æŠ€èƒ½ä¸æ¶ˆè€—é­”æ³•å€¼ï¼Ÿ

A: ä½¿ç”¨ CastSource.COMMAND æˆ– CastSource.SCROLLã€‚

Q2: å¦‚ä½•è·³è¿‡å†·å´æ—¶é—´ï¼Ÿ

A: åœ¨ attemptInitiateCast() ä¸­å°† triggerCooldown å‚æ•°è®¾ä¸º falseã€‚

Q3: å¦‚ä½•åœ¨å®¢æˆ·ç«¯è·å–é­”æ³•æ•°æ®ï¼Ÿ

A: ä½¿ç”¨ ClientMagicData.getSpellSelectionManager() å’Œç›¸å…³å®¢æˆ·ç«¯ APIã€‚

Q4: CastData ä½•æ—¶è¢«æ¸…ç†ï¼Ÿ

A: è°ƒç”¨ resetCastingState() æˆ– resetAdditionalCastData() æ—¶è‡ªåŠ¨è°ƒç”¨ reset()ã€‚

Q5: å¦‚ä½•å®ç°å¤šæ®µæ–½æ³•æŠ€èƒ½ï¼Ÿ

A: ä½¿ç”¨ Recast ç³»ç»Ÿï¼Œåœ¨ onCast() ä¸­æ£€æŸ¥ playerRecasts.hasRecastForSpell()ã€‚

Q6: æŠ€èƒ½å‚æ•°å¦‚ä½•åœ¨å®¢æˆ·ç«¯-æœåŠ¡ç«¯ä¹‹é—´åŒæ­¥ï¼Ÿ

A: é€šè¿‡ ClientboundOnClientCast ç½‘ç»œåŒ…ï¼ŒåŒ…å«åºåˆ—åŒ–çš„ ICastDataSerializableã€‚

Q7: å¦‚ä½•åˆ›å»ºéœ€è¦é€‰æ‹©ç›®æ ‡çš„æŠ€èƒ½ï¼Ÿ

A: åœ¨ checkPreCastConditions() ä¸­è°ƒç”¨ Utils.preCastTargetHelper()ã€‚

Q8: å¦‚ä½•è°ƒè¯•æŠ€èƒ½é€»è¾‘ï¼Ÿ

A: å¯ç”¨ Log.SPELL_DEBUG = trueï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¾“å‡ºã€‚

---
17. æ€»ç»“

Iron's Spells 'n Spellbooks æ˜¯ä¸€ä¸ªæ¶æ„æ¸…æ™°ã€é«˜åº¦æ¨¡å—åŒ–çš„ Minecraft é­”æ³•ç³»ç»Ÿ Modã€‚å…¶æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š

1. æŠ½è±¡ä¸ç»§æ‰¿: é€šè¿‡ AbstractSpell ç»Ÿä¸€æŠ€èƒ½æ¥å£
2. æ•°æ®é©±åŠ¨: é…ç½®ç³»ç»Ÿæ”¯æŒçµæ´»è°ƒæ•´æŠ€èƒ½å‚æ•°
3. å®¢æˆ·ç«¯-æœåŠ¡ç«¯åˆ†ç¦»: ç½‘ç»œé€šä¿¡ä¿è¯åŒæ­¥ï¼Œé€»è¾‘åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
4. å¯æ‰©å±•æ€§: ICastData æ¥å£æ”¯æŒä»»æ„è‡ªå®šä¹‰å‚æ•°
5. äº‹ä»¶é©±åŠ¨: Forge äº‹ä»¶ç³»ç»Ÿå…è®¸å¤–éƒ¨å¹²é¢„æ–½æ³•æµç¨‹
6. çŠ¶æ€ç®¡ç†: MagicData é›†ä¸­ç®¡ç†ç©å®¶é­”æ³•çŠ¶æ€
7. Recast æœºåˆ¶: æ”¯æŒè¿å‡»ã€å¤šæ®µã€å»¶æ—¶ç­‰å¤æ‚æ–½æ³•æ¨¡å¼

å…³é”®æ–‡ä»¶è·¯å¾„æ±‡æ€»:
- æŠ€èƒ½åŸºç±»: api/spells/AbstractSpell.java
- æŠ€èƒ½æ³¨å†Œ: api/registry/SpellRegistry.java
- é­”æ³•æ•°æ®: api/magic/MagicData.java
- é­”æ³•ç®¡ç†: capabilities/magic/MagicManager.java
- æ–½æ³•æŒ‡ä»¤: command/CastCommand.java
- ç½‘ç»œé€šä¿¡: network/ServerboundCast.java, network/ClientboundOnClientCast.java
- è¾“å…¥å¤„ç†: player/ClientInputEvents.java
- å…·ä½“æŠ€èƒ½: spells/{school}/{SpellName}Spell.java

å¸Œæœ›æ­¤æŠ¥å‘Šèƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£æ•´ä¸ªæ–½æ³•ç³»ç»Ÿçš„æ¶æ„ä¸å®ç°ç»†èŠ‚ï¼